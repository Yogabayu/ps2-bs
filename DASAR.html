<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hitung Durasi Waktu</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="container mt-5">
    <h1>Hitung Durasi Waktu</h1>

    <form id="waktuForm">
      <div class="form-group">
        <label for="waktuMulai">Waktu Mulai:</label>
        <div class="input-group mb-3">
          <div class="input-group-append">
            <button
              class="btn btn-primary"
              type="button"
              onclick="setWaktu('mulai')"
            >
              Tapin
            </button>
          </div>
          <input
            type="text"
            class="form-control"
            id="waktuMulai"
            placeholder="Waktu Mulai"
            readonly
          />
        </div>
      </div>

      <div class="form-group">
        <label for="waktuSelesai">Waktu Selesai:</label>
        <div class="input-group mb-3">
          <div class="input-group-append">
            <button
              class="btn btn-primary"
              type="button"
              onclick="setWaktu('selesai')"
            >
              Tapout
            </button>
          </div>
          <input
            type="text"
            class="form-control"
            id="waktuSelesai"
            placeholder="Waktu Selesai"
            readonly
          />
        </div>
      </div>

      <div class="form-group">
        <label for="video">Video:</label>
        <video id="video" width="640" height="480" controls></video>
      </div>

      <div class="form-group">
        <label for="transcation">Transaksi:</label>
        <div class="input-group mb-3">
          <select id="transcation" name="transcation">
            <option value="10.1">ST TN WALK IN</option>
            <option value="10.2">ST TN ao</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="nominal">Nominal: </label>
        <div class="input-group mb-3">
          <input type="number" id="nominal" name="nominal" />
        </div>
      </div>

      <div class="form-group">
        <label for="place">Tempat Transaksi: </label>
        <div class="input-group mb-3">
          <input type="text" id="place" name="place" />
        </div>
      </div>

      <button type="button" class="btn btn-success" onclick="hitungDurasi()">
        Lihat hasil
      </button>
      <hr />

      <div class="form-group">
        <label for="hasilTransaksi">Tansaksi :</label>

        <p id="hasilTransaksi"></p>
      </div>

      <div class="form-group">
        <label for="hasilCalc">Hasil :</label>

        <p id="hasilCalc"></p>
      </div>

      <div class="form-group">
        <label for="hasilDurasi">Hasil :</label>

        <p id="hasilDurasi"></p>
      </div>
    </form>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      var waktuMulai = null;
      var waktuSelesai = null;
      let mediaRecorder;
      let recordedChunks = [];

      function setWaktu(jenis) {
        var waktu = new Date();
        var jam = waktu.getHours().toString().padStart(2, "0");
        var menit = waktu.getMinutes().toString().padStart(2, "0");
        var detik = waktu.getSeconds().toString().padStart(2, "0");
        var waktuString = jam + ":" + menit + ":" + detik;

        if (jenis === "mulai") {
          waktuMulai = waktuString;
          document.getElementById("waktuMulai").value = waktuMulai;
          startRecording();
        } else if (jenis === "selesai") {
          waktuSelesai = waktuString;
          document.getElementById("waktuSelesai").value = waktuSelesai;
          stopRecording();
        }
      }

      function startRecording() {
        navigator.mediaDevices
          .getDisplayMedia({ video: true })
          .then(function (stream) {
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = function (event) {
              if (event.data.size > 0) {
                recordedChunks.push(event.data);
              }
            };

            mediaRecorder.onstop = function () {
              var blob = new Blob(recordedChunks, { type: "video/webm" });
              var videoUrl = URL.createObjectURL(blob);
              document.getElementById("video").src = videoUrl;

              recordedChunks = [];
            };

            mediaRecorder.start();
          })
          .catch(function (error) {
            console.error("Error accessing screen: ", error);
          });
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
      }

      function hitungDurasi() {
        //hitung waktu
        if (!waktuMulai || !waktuSelesai) {
          document.getElementById("hasilDurasi").textContent =
            "Waktu mulai dan selesai belum diatur.";
          return;
        }

        var durasiMulai = new Date("2000-01-01 " + waktuMulai);
        var durasiSelesai = new Date("2000-01-01 " + waktuSelesai);
        var durasiMilidetik = durasiSelesai - durasiMulai;
        var durasiDetik = Math.floor(durasiMilidetik / 1000);
        var durasiMenit = Math.floor(durasiDetik / 60);

        var sisaDetik = durasiDetik % 60;
        var hasilDurasi = durasiMenit + " menit " + sisaDetik + " detik";

        document.getElementById("hasilDurasi").textContent =
          "Durasi: " + hasilDurasi;

        //transaksi
        var hasil = null;
        var patokan1 = 5;
        var patokan2 = 3;
        var detailTrans = null;
        var trans = document.getElementById("transcation").value;

        if (trans == "10.1") {
          if (durasiMenit <= patokan1) {
            hasil = "Sesuai";
          } else {
            hasil = "tidak sesuai";
          }
          detailTrans = "Kode transaksi: 10.1 , Jenis transaksi: ST TN WALK IN";
        } else if (trans == "10.2") {
          if (durasiMenit <= patokan2) {
            hasil = "Sesuai";
          } else {
            hasil = "tidak sesuai";
          }

          detailTrans = "Kode transaksi: 10.2 , Jenis transaksi: ST TN AO";
        } else {
          hasil = "undefined if";
          detailTrans = "undefined if";
        }

        document.getElementById("hasilTransaksi").textContent = detailTrans;
        document.getElementById("hasilCalc").textContent = hasil;

        var formData = new FormData();
        formData.append("waktuMulai", waktuMulai);
        formData.append("waktuSelesai", waktuSelesai);
        formData.append(
          "transcation",
          document.getElementById("transcation").value
        );
        formData.append("nominal", document.getElementById("nominal").value);
        formData.append("place", document.getElementById("place").value);

        // Mendapatkan hasil rekaman video sebagai Blob
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }

        // Membuat objek Blob dari recordedChunks
        var blob = new Blob(recordedChunks, { type: "video/webm" });

        // Menambahkan hasil rekaman video ke FormData
        formData.append("video", blob, "rekaman.webm");
        for (var pair of formData.entries()) {
          console.log(pair[0] + ": " + pair[1]);
        }
        console.log(...formData);

        // Mengirim formulir menggunakan Ajax
        // fetch("/path/to/submit-endpoint", {
        //   method: "POST",
        //   body: formData,
        // })
        //   .then((response) => response.json())
        //   .then((data) => {
        //     console.log(data.message); // Menangani respons dari server jika diperlukan
        //   });
      }
    </script>
  </body>
</html>
